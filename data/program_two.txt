; PROGRAM 2
; A program that reads a set of a paragraph of 6 sentences from a file into
; memory. It prints the sentences on the console printer. It then asks the user for a word. It
; searches the paragraph to see if it contains the word. If so, it prints out the word, the
; sentence number, and the word number in the sentence.

; Step by step how program 2 is working:
; 1. Read 6 sentences from a file into memory using the IN instruction and DEVID = 2 (card reader) and CHK.
;       This will be done in the READ_STRING_FROM_DEVICE subroutine.
; 2. Print this message to the console using the PRINT_STRING subroutine.
; 3. Prompt the user for a word using the PRINT_STRING subroutine and a pre-made message.
; 4. Record the word entered using the READ_STRING subroutine.
; 5. Search the paragraph for the word entered. This will be done in the FIND_WORD subroutine.
;       Save the sentence number and word number in the sentence where the word is found.
; 6. Finally, print out the word, sentence number, and word number in the sentence if the word is found.
;       This can either be done in a subroutine or in the main program.

; A quick not about memory layout. I will try to reserve 0-1023 for data, constants, and variables.
; Program START begins at 1024 (octal 2000).
; Subroutines will be above all code in the START program.

; LOW MEMORY (6-31): lookup tables for subroutines etc. and some variables
;currently at 0 out of 32 words
        LOC 6
        ; soubroutine jump tables
        J_TABLE_1_ADDR: Data J_TABLE_1

        ; Constants
        ZERO:        Data 0

        ; Variables
        ; Memory address locations (for different variables)
        HIGHMEM_ADDR_1: Data HIGHMEM_1
        STRING_ARRAY_ADDR: Data STRING_ARRAY

        ;index register temp store - used to maintain index state after subroutine call
        ;Note: I try to keep a "focus" for each index register. However, in the subroutines,
        ;this will be mostly ignored since the main code index registers are stored and restored
        ;in the subroutine.
        TEMPX1:       Data 0 ;use this mostly for subroutines
        TEMPX2:       Data 0 ;use this mostly for ARRAY
        TEMPX3:       Data 0 ;use this mostly for HIGHNUM

        ;high memory locations. Don't assign these directly, maintain a list of comments noting
        ;  what each offset relates to. 32-127 is used for variables.
        LOC 32
        HIGHMEM_1:    Data 0

        ;jump table locations
        LOC 128 ; 128-255 is used for subroutine jump tables (J_TABLE_1, J_TABLE_2, J_TABLE_3, J_TABLE_4 32-words each)
J_TABLE_1:
        READ_STRING_FROM_DEVICE_ADDR:         Data READ_STRING_FROM_DEVICE           ;0
        READ_CHAR_LOOP_ADDR:                  Data READ_CHAR_LOOP                    ;1
        READ_DONE_ADDR:                       Data READ_DONE                         ;2
        PRINT_STRING_ADDR:                    Data PRINT_STRING                      ;3
        PRINT_LOOP_ADDR:                      Data PRINT_LOOP                        ;4
        PRINT_DONE_ADDR:                      Data PRINT_DONE                        ;5

        LOC 256 ; 256-1023 is used for saving the string. That implies the max length of the string is 767 characters.
        STRING_ARRAY: Data 0 ;index 0 for the string. Print string by looping until you hit a null pointer.

; -------------------------main program------------------------------
; CODE SECTION: Main program and subroutines: memory range 1024-2047
        LOC 1024 ;octal 2000
START:
        ;1. read 6 sentences from a file into memory using the IN instruction and DEVID = 2 (card reader).
        LDX 1, J_TABLE_1_ADDR
        JSR 1, 0, 1             ; Call READ_STRING_FROM_DEVICE (X1+0 with indirect)

        ; 2. Print this message to the console using the PRINT_STRING subroutine.
        LDX 1, J_TABLE_1_ADDR
        LDX 2, STRING_ARRAY_ADDR ; X2 = pointer to string to print
        JSR 1, 3, 1             ; Call PRINT_STRING (X1+3 with indirect)

        HLT

; -------------------------coroutines------------------------------

; READ_STRING_FROM_DEVICE subroutine
; Reads characters from card reader (DEVID=2) into STRING_ARRAY until EOF
; Card reader returns 0 (null character) at end of file
READ_STRING_FROM_DEVICE:
        ;index register temp store
        STX 1, TEMPX1
        STX 2, TEMPX2
        STX 3, TEMPX3

        ;start - load jump table and string array pointer
        LDX 1, J_TABLE_1_ADDR      ; X1 = jump table address for subroutine jumps
        LDX 2, STRING_ARRAY_ADDR    ; X2 = STRING_ARRAY address (256)

        ; Fall through to READ_CHAR_LOOP

READ_CHAR_LOOP:
        IN 1, 2                     ; Read one character from card reader (DEVID=2) into R1

        ; Check for EOF (card reader returns 0 at end of file)
        JZ 1, 1, 2, 1               ; If R1 = 0 (EOF), jump to READ_DONE (X1+2 with indirect)

        ; Store character in STRING_ARRAY
        STR 1, 2, 0                 ; Store character at X2+0

        ; Increment X2 to point to next memory location
        STX 2, TEMPX2               ; Save X2 to TEMPX2
        LDR 0, 0, TEMPX2            ; Load X2 value into R0
        AIR 0, 1                    ; Increment by 1
        STR 0, 0, TEMPX2            ; Store back to TEMPX2
        LDX 2, TEMPX2               ; Reload X2 with incremented value

        ; Loop back to read next character
        JMA 1, 1, 1                 ; Jump to READ_CHAR_LOOP (X1+1 with indirect)

READ_DONE:
        ; Store null terminator at end of string
        LDR 0, 0, ZERO              ; R0 = 0
        STR 0, 2, 0                 ; Store null terminator at X2+0

        ;reload index register temp store
        LDX 1, TEMPX1
        LDX 2, TEMPX2
        LDX 3, TEMPX3

        ;exit
        RFS 0



; PRINT_STRING subroutine
; Prints null-terminated string to console printer (DEVID=1)
; Input: X2 should point to start of string (set before calling JSR)
PRINT_STRING:
        ;index register temp store
        STX 1, TEMPX1
        STX 2, TEMPX2
        STX 3, TEMPX3

        ;start - load jump table
        LDX 1, J_TABLE_1_ADDR      ; X1 = jump table address for subroutine jumps
        ; X2 already contains the string address (passed in by caller)

        ; Fall through to PRINT_LOOP

PRINT_LOOP:
        LDR 0, 2, 0                 ; Load character from X2+0 into R0

        ; Check for null terminator
        JZ 0, 1, 5, 1               ; If R0 = 0 (null), jump to PRINT_DONE (X1+5 with indirect)

        ; Print character to console
        OUT 0, 1                    ; Output to console printer (DEVID=1)

        ; Increment X2 to point to next character
        STX 2, TEMPX2               ; Save X2 to TEMPX2
        LDR 0, 0, TEMPX2            ; Load X2 value into R0
        AIR 0, 1                    ; Increment by 1
        STR 0, 0, TEMPX2            ; Store back to TEMPX2
        LDX 2, TEMPX2               ; Reload X2 with incremented value

        ; Loop back to print next character
        JMA 1, 4, 1                 ; Jump to PRINT_LOOP (X1+4 with indirect)

PRINT_DONE:
        ;reload index register temp store
        LDX 1, TEMPX1
        LDX 2, TEMPX2
        LDX 3, TEMPX3

        ;exit
        RFS 0

; READ_STRING subroutine
READ_STRING:
        ;index register temp store
        STX 1, TEMPX1
        STX 2, TEMPX2
        STX 3, TEMPX3

        ;subroutine here
        ;reload index register temp store
        LDX 1, TEMPX1
        LDX 2, TEMPX2
        LDX 3, TEMPX3

        ;exit
        RFS 0

; FIND_WORD subroutine
FIND_WORD:
        ;index register temp store
        STX 1, TEMPX1
        STX 2, TEMPX2
        STX 3, TEMPX3

        ;subroutine here
        ;reload index register temp store
        LDX 1, TEMPX1
        LDX 2, TEMPX2
        LDX 3, TEMPX3

        ;exit
        RFS 0